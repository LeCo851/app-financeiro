<div class="layout-wrapper">

  <!-- HEADER FIXO -->
  <header class="app-header">
    <div class="header-content">
      <div class="logo-area">
        <div class="logo-icon">
          <i class="pi pi-wallet"></i>
        </div>
        <span class="logo-text">Financeiro AI</span>
      </div>

      <div class="actions-area">
        <p-button
          [icon]="isDarkMode ? 'pi pi-sun' : 'pi pi-moon'"
          [text]="true"
          severity="secondary"
          [pTooltip]="isDarkMode ? 'Modo Claro' : 'Modo Escuro'"
          tooltipPosition="bottom"
          (onClick)="toggleTheme()">
        </p-button>

        <div class="separator"></div>

        <p-button
          label="Conectar Conta"
          icon="pi pi-building-columns"
          [text]="true"
          severity="secondary"
          styleClass="p-button-sm"
          [loading]="connecting"
          (onClick)="connectBank()">
        </p-button>

        <p-button
          label="Atualizar"
          icon="pi pi-refresh"
          [outlined]="true"
          severity="secondary"
          styleClass="p-button-sm"
          [loading]="refreshing"
          (onClick)="refreshData()">
        </p-button>

        <p-button
          label="Nova Transação"
          icon="pi pi-plus"
          styleClass="p-button-sm"
          (onClick)="showDialog()">
        </p-button>

        <div class="separator"></div>

        <p-button
          icon="pi pi-power-off"
          [text]="true"
          severity="secondary"
          pTooltip="Sair"
          tooltipPosition="bottom"
          (onClick)="logout()">
        </p-button>
      </div>
    </div>
  </header>

  <main class="dashboard-container">

    <!-- FILTROS DE DATA -->
    <div class="filters-section">
      <div class="filter-group">
        <label for="year">Ano</label>
        <p-select
          inputId="year"
          [options]="years"
          [(ngModel)]="selectedYear"
          optionLabel="label"
          optionValue="value"
          (onChange)="loadData()"
          placeholder="Ano"
          styleClass="w-full">
        </p-select>
      </div>
      <div class="filter-group">
        <label for="month">Mês</label>
        <p-select
          inputId="month"
          [options]="months"
          [(ngModel)]="selectedMonth"
          optionLabel="label"
          optionValue="value"
          (onChange)="loadData()"
          placeholder="Mês"
          styleClass="w-full">
        </p-select>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <!-- Saldo Corrente -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper blue">
          <i class="pi pi-wallet"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Saldo em Conta</span>
          <span class="kpi-value">{{ currentBalance | currency:'BRL' }}</span>
        </div>
      </div>

      <!-- Salário Médio -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper indigo">
          <i class="pi pi-money-bill"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Média Salarial</span>
          <span class="kpi-value">{{ averageIncome | currency:'BRL' }}</span>
        </div>
      </div>

      <!-- Investimentos -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper purple">
          <i class="pi pi-chart-line"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Investimentos</span>
          <span class="kpi-value">{{ totalInvested | currency:'BRL' }}</span>
        </div>
      </div>

      <!-- Balanço do Mês -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper teal">
          <i class="pi pi-calendar"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Balanço do Mês</span>
          <span class="kpi-value" [ngClass]="{'text-green-600': totalBalance >= 0, 'text-red-600': totalBalance < 0}">
            {{ totalBalance | currency:'BRL' }}
          </span>
        </div>
      </div>

      <!-- Entradas -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper green">
          <i class="pi pi-arrow-up"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Entradas</span>
          <span class="kpi-value text-green-600">{{ totalIncome | currency:'BRL' }}</span>
        </div>
      </div>

      <!-- Saídas -->
      <div class="kpi-card">
        <div class="kpi-icon-wrapper red">
          <i class="pi pi-arrow-down"></i>
        </div>
        <div class="kpi-content">
          <span class="kpi-label">Saídas</span>
          <span class="kpi-value text-red-600">{{ totalExpense | currency:'BRL' }}</span>
        </div>
      </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="charts-grid">
      <!-- Gráfico de Rosca -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Despesas por Categoria</h3>
        </div>
        <div class="chart-body">
          <plotly-plot
            [data]="donutGraph.data"
            [layout]="donutGraph.layout"
            [config]="donutGraph.config"
            [style]="{width: '100%', height: '100%'}"
            (plotlyClick)="onChartClick($event, 'donut')">
          </plotly-plot>
        </div>
      </div>

      <!-- Gráfico de Barras -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Receitas vs Despesas (12 Meses)</h3>
        </div>
        <div class="chart-body">
          <plotly-plot
            [data]="barGraph.data"
            [layout]="barGraph.layout"
            [config]="barGraph.config"
            [style]="{width: '100%', height: '100%'}"
            (plotlyClick)="onChartClick($event, 'bar')">
          </plotly-plot>
        </div>
      </div>

      <!-- Gráfico Treemap -->
      <div class="chart-card full-width">
        <div class="chart-header">
          <h3>Mapa Hierárquico de Renda</h3>
        </div>
        <div class="chart-body">
          <plotly-plot
            [data]="treemapGraph.data"
            [layout]="treemapGraph.layout"
            [config]="treemapGraph.config"
            [style]="{width: '100%', height: '100%'}">
          </plotly-plot>
        </div>
      </div>
    </div>

    <!-- TABELA DE TRANSAÇÕES -->
    <div class="table-card">
      <div class="table-header-custom">
        <h3>Minhas Transações</h3>
        <div class="search-box">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            [(ngModel)]="searchValue"
            (input)="dt.filterGlobal($any($event.target).value, 'contains')"
            placeholder="Buscar transação..." />
        </div>
      </div>

      <p-table
        #dt
        [value]="transactions"
        [loading]="loading"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [globalFilterFields]="['description', 'amount', 'typeLabel', 'merchantName', 'categoryName']"
        styleClass="p-datatable-striped"
        [tableStyle]="{ 'min-width': '60rem' }">

        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="description">Descrição <p-sortIcon field="description"></p-sortIcon></th>
            <th pSortableColumn="merchantName">Estabelecimento <p-sortIcon field="merchantName"></p-sortIcon></th>
            <th pSortableColumn="categoryName">Categoria <p-sortIcon field="categoryName"></p-sortIcon></th>
            <th pSortableColumn="date">Data <p-sortIcon field="date"></p-sortIcon></th>
            <th pSortableColumn="type">Tipo <p-sortIcon field="type"></p-sortIcon></th>
            <th pSortableColumn="amount" class="text-right">Valor <p-sortIcon field="amount"></p-sortIcon></th>
            <th class="text-center" style="width: 5rem"></th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-t>
          <tr>
            <td>
              <div class="font-semibold text-900">{{ t.description }}</div>
              <div *ngIf="t.totalInstallments" class="text-xs text-500 mt-1">
                Parcela {{ t.currentInstallment || 1 }}/{{ t.totalInstallments }}
              </div>
            </td>

            <td>
              <span *ngIf="t.merchantName" class="text-700">{{ t.merchantName }}</span>
              <span *ngIf="!t.merchantName" class="text-400">-</span>
            </td>

            <td>
              <span *ngIf="t.categoryName" class="category-badge" [style.background-color]="t.categoryColor || '#f1f5f9'">
                {{ t.categoryName }}
              </span>
            </td>

            <td class="text-600">
              {{ t.date | date:'dd/MM/yyyy' }}
            </td>

            <td>
              <span [class]="'type-badge ' + t.type.toLowerCase()">
                {{ t.typeLabel }}
              </span>
            </td>

            <td class="text-right font-medium">
              <span [class]="t.type === 'INCOME' ? 'text-green-600' : t.type === 'INVESTMENT' ? 'text-purple-600' : 'text-red-600'">
                {{ t.amount | currency:'BRL' }}
              </span>
            </td>

            <td class="text-center flex align-items-center justify-content-center gap-2">
              <button
                class="action-btn edit"
                (click)="editTransaction(t)"
                pTooltip="Editar"
                tooltipPosition="top">
                <i class="pi pi-pencil"></i>
              </button>

              <button
                class="action-btn delete"
                (click)="deleteTransaction(t)"
                pTooltip="Excluir"
                tooltipPosition="left">
                <i class="pi pi-trash"></i>
              </button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center p-6 text-500">
              <div class="empty-state">
                <i class="pi pi-inbox"></i>
                <p>Nenhuma transação encontrada.</p>
              </div>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </div>

  </main>
</div>

<!-- DIALOG -->
<p-dialog
  header="Nova Transação"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false"
  [resizable]="false"
  styleClass="custom-dialog">

  <div class="flex flex-column gap-4 pt-2">

    <div class="flex flex-column gap-2">
      <label for="description" class="font-semibold text-sm text-700">Descrição</label>
      <input
        pInputText
        id="description"
        [(ngModel)]="currentTransaction.description"
        class="w-full"
        autocomplete="off"
        placeholder="Ex: Conta de Luz" />
    </div>

    <div class="flex flex-column gap-2">
      <label for="amount" class="font-semibold text-sm text-700">Valor</label>
      <p-inputNumber
        inputId="amount"
        [(ngModel)]="currentTransaction.amount"
        mode="currency"
        currency="BRL"
        locale="pt-BR"
        styleClass="w-full"
        inputStyleClass="w-full"
        placeholder="R$ 0,00">
      </p-inputNumber>
    </div>

    <div class="flex flex-column gap-2">
      <label for="date" class="font-semibold text-sm text-700">Data</label>
      <p-datepicker
        inputId="date"
        [(ngModel)]="currentTransaction.date"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        appendTo="body"
        styleClass="w-full"
        inputStyleClass="w-full">
      </p-datepicker>
    </div>

    <div class="flex flex-column gap-2">
      <label for="type" class="font-semibold text-sm text-700">Tipo</label>
      <p-select
        inputId="type"
        [options]="types"
        [(ngModel)]="currentTransaction.type"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full"
        appendTo="body"
        placeholder="Selecione o tipo">
      </p-select>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      [text]="true"
      severity="secondary"
      (onClick)="displayDialog = false">
    </p-button>

    <p-button
      label="Salvar"
      icon="pi pi-check"
      [loading]="saving"
      (onClick)="saveTransaction()">
    </p-button>
  </ng-template>

</p-dialog>

<!-- DIALOG DE SINCRONIZAÇÃO -->
<p-dialog
  [(visible)]="isSyncing"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="false"
  [draggable]="false"
  [resizable]="false"
  styleClass="sync-dialog">

  <div class="flex flex-column align-items-center justify-content-center text-center gap-3 py-4">
    <div class="spinner-wrapper">
      <i class="pi pi-spin pi-sync text-5xl text-primary"></i>
    </div>
    <div>
      <h2 class="text-xl font-bold mb-2 text-900">Sincronizando</h2>
      <p class="text-600 line-height-3 m-0 text-sm">
        Conectando ao banco para buscar suas transações recentes.
      </p>
    </div>
  </div>
</p-dialog>
