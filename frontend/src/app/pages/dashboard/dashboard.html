<div class="dashboard-container">

  <!-- TOOLBAR -->
  <p-toolbar styleClass="custom-toolbar">
    <div class="p-toolbar-group-start">
      <i class="pi pi-wallet text-2xl mr-2 text-primary"></i>
      <span class="font-bold text-xl text-900">Financeiro AI</span>
    </div>

    <div class="p-toolbar-group-end gap-2">
      <p-button
        label="Conectar Conta"
        icon="pi pi-building-columns"
        severity="help"
        [loading]="connecting"
        (onClick)="connectBank()">
      </p-button>
      <p-button
        label="Nova Transação"
        icon="pi pi-plus"
        (onClick)="showDialog()">
      </p-button>
      <p-button
        label="Sair"
        icon="pi pi-power-off"
        severity="danger"
        [text]="true"
        (onClick)="logout()">
      </p-button>
    </div>
  </p-toolbar>

  <!-- FILTROS DE DATA -->
  <div class="filters-section">
    <div class="flex flex-column">
      <label for="month">Mês</label>
      <p-select
        inputId="month"
        [options]="months"
        [(ngModel)]="selectedMonth"
        optionLabel="label"
        optionValue="value"
        (onChange)="loadData()"
        placeholder="Selecione o mês"
        [style]="{'width': '180px'}">
      </p-select>
    </div>

    <div class="flex flex-column">
      <label for="year">Ano</label>
      <p-select
        inputId="year"
        [options]="years"
        [(ngModel)]="selectedYear"
        optionLabel="label"
        optionValue="value"
        (onChange)="loadData()"
        placeholder="Selecione o ano"
        [style]="{'width': '120px'}">
      </p-select>
    </div>
  </div>

  <!-- KPIs -->
  <div class="dashboard-kpis">
    <!-- Saldo Corrente -->
    <p-card styleClass="kpi-card">
      <div class="kpi-header">
        <div class="kpi-content">
          <span class="kpi-title">Saldo Corrente</span>
          <div class="kpi-value">{{ currentBalance | currency:'BRL' }}</div>
        </div>
        <div class="kpi-icon blue">
          <i class="pi pi-wallet"></i>
        </div>
      </div>
    </p-card>

    <!-- Saldo do Mês -->
    <p-card styleClass="kpi-card">
      <div class="kpi-header">
        <div class="kpi-content">
          <span class="kpi-title">Saldo do Mês</span>
          <div class="kpi-value" [ngClass]="{'green': totalBalance >= 0, 'red': totalBalance < 0}">
            {{ totalBalance | currency:'BRL' }}
          </div>
        </div>
        <div class="kpi-icon blue">
          <i class="pi pi-calendar"></i>
        </div>
      </div>
    </p-card>

    <!-- Investimentos -->
    <p-card styleClass="kpi-card">
      <div class="kpi-header">
        <div class="kpi-content">
          <span class="kpi-title">Investimentos</span>
          <div class="kpi-value">{{ totalInvested | currency:'BRL' }}</div>
        </div>
        <div class="kpi-icon purple">
          <i class="pi pi-chart-line"></i>
        </div>
      </div>
    </p-card>

    <!-- Receitas -->
    <p-card styleClass="kpi-card">
      <div class="kpi-header">
        <div class="kpi-content">
          <span class="kpi-title">Receitas</span>
          <div class="kpi-value green">{{ totalIncome | currency:'BRL' }}</div>
        </div>
        <div class="kpi-icon green">
          <i class="pi pi-arrow-up"></i>
        </div>
      </div>
    </p-card>

    <!-- Despesas -->
    <p-card styleClass="kpi-card">
      <div class="kpi-header">
        <div class="kpi-content">
          <span class="kpi-title">Despesas</span>
          <div class="kpi-value red">{{ totalExpense | currency:'BRL' }}</div>
        </div>
        <div class="kpi-icon red">
          <i class="pi pi-arrow-down"></i>
        </div>
      </div>
    </p-card>
  </div>

  <!-- TABELA DE TRANSAÇÕES -->
  <p-card header="Minhas Transações" styleClass="transactions-card">
    <p-table
      #dt
      [value]="transactions"
      [loading]="loading"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="['description', 'amount', 'type', 'merchantName', 'categoryName']"
      styleClass="p-datatable-sm"
      [tableStyle]="{ 'min-width': '50rem' }">

      <ng-template pTemplate="caption">
        <div class="flex justify-content-end">
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input
              pInputText
              type="text"
              [(ngModel)]="searchValue"
              (input)="dt.filterGlobal($any($event.target).value, 'contains')"
              placeholder="Buscar transação..."
              class="p-inputtext-sm w-20rem" />
          </p-iconfield>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="description">Descrição <p-sortIcon field="description"></p-sortIcon></th>
          <th pSortableColumn="merchantName">Estabelecimento <p-sortIcon field="merchantName"></p-sortIcon></th>
          <th pSortableColumn="categoryName">Categoria <p-sortIcon field="categoryName"></p-sortIcon></th>
          <th pSortableColumn="date">Data <p-sortIcon field="date"></p-sortIcon></th>
          <th pSortableColumn="type">Tipo <p-sortIcon field="type"></p-sortIcon></th>
          <th pSortableColumn="amount">Valor <p-sortIcon field="amount"></p-sortIcon></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-t>
        <tr>
          <td>
            <div class="font-bold text-900">{{ t.description }}</div>
            <div *ngIf="t.totalInstallments" class="text-xs text-500 mt-1">
              Parcela {{ t.currentInstallment || 1 }}/{{ t.totalInstallments }}
            </div>
          </td>

          <td>
            <span *ngIf="t.merchantName" class="text-700">{{ t.merchantName }}</span>
            <span *ngIf="!t.merchantName" class="text-400 italic">-</span>
          </td>

          <td>
            <p-tag
              *ngIf="t.categoryName"
              [value]="t.categoryName"
              [style]="{ 'background-color': t.categoryColor || '#f1f5f9', 'color': '#475569', 'font-weight': '600' }">
            </p-tag>
          </td>

          <td class="text-600">{{ t.date | date:'dd/MM/yyyy' : '+0000' }}</td>

          <td>
            <span [class]="t.type === 'INCOME' ?
                'bg-green-100 text-green-700 px-2 py-1 border-round font-bold text-xs uppercase' :
                'bg-red-100 text-red-700 px-2 py-1 border-round font-bold text-xs uppercase'">
                {{ t.type === 'INCOME' ? 'Receita' : 'Despesa' }}
            </span>
          </td>

          <td [class]="t.type === 'INCOME' ? 'text-green-600 font-bold text-lg' : 'text-red-600 font-bold text-lg'">
            {{ t.amount | currency:'BRL' }}
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center p-6 text-500">
            <i class="pi pi-inbox text-4xl mb-3 block text-300"></i>
            Nenhuma transação encontrada para o período selecionado.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- DIALOG -->
<p-dialog
  header="Nova Transação"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false"
  [resizable]="false"
  styleClass="custom-dialog">

  <div class="flex flex-column gap-4 pt-2">

    <div class="flex flex-column gap-2">
      <label for="description" class="font-bold text-sm text-700">Descrição</label>
      <input
        pInputText
        id="description"
        [(ngModel)]="currentTransaction.description"
        class="w-full"
        autocomplete="off"
        placeholder="Ex: Conta de Luz" />
    </div>

    <div class="flex flex-column gap-2">
      <label for="amount" class="font-bold text-sm text-700">Valor</label>
      <p-inputNumber
        inputId="amount"
        [(ngModel)]="currentTransaction.amount"
        mode="currency"
        currency="BRL"
        locale="pt-BR"
        styleClass="w-full"
        inputStyleClass="w-full"
        placeholder="R$ 0,00">
      </p-inputNumber>
    </div>

    <div class="flex flex-column gap-2">
      <label for="date" class="font-bold text-sm text-700">Data</label>
      <p-datepicker
        inputId="date"
        [(ngModel)]="currentTransaction.date"
        dateFormat="dd/mm/yy"
        [showIcon]="true"
        appendTo="body"
        styleClass="w-full"
        inputStyleClass="w-full">
      </p-datepicker>
    </div>

    <div class="flex flex-column gap-2">
      <label for="type" class="font-bold text-sm text-700">Tipo</label>
      <p-select
        inputId="type"
        [options]="types"
        [(ngModel)]="currentTransaction.type"
        optionLabel="label"
        optionValue="value"
        styleClass="w-full"
        appendTo="body"
        placeholder="Selecione o tipo">
      </p-select>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      [text]="true"
      severity="secondary"
      (onClick)="displayDialog = false">
    </p-button>

    <p-button
      label="Salvar"
      icon="pi pi-check"
      [loading]="saving"
      (onClick)="saveTransaction()">
    </p-button>
  </ng-template>

</p-dialog>
